# データベースの必要性検討

**調査日**: 2025-11-11
**関連**: [Phase 1 要件定義](../logs/2025-11-11-phase1-requirements.md)

---

## 調査目的

Phase 1 では「データベース不要（Google Calendar をデータソースとして使用）」としていたが、要件を実現するためにデータベースが必要になる可能性を検討する。

---

## データベースが必要になりそうな要件

### 1. 予約リクエストの状態管理（3 段階フロー）

- **要件**: リクエスト → 承認/調整 → FIX の状態を管理
- **課題**: Google Calendar には確定した予約しか入らないため、リクエスト中や調整中の状態を管理する必要がある
- **検討**: メモリやファイルベースで一時管理できるか？それとも永続化が必要か？

### 2. 予約リクエストの一覧表示（美容師側）**【マスト】**

- **要件**: 美容師が承認/調整するために、リクエスト一覧を見る必要がある（**必須要件**）
- **課題**: Google Calendar だけでは、まだ確定していないリクエストは表示できない
- **結論**: **データベースまたはファイルベースが必要**（承認・調整待ちのリクエストを管理できないと運用が回らない）

### 3. 長期休暇のお知らせの管理

- **要件**: 美容師が設定可能
- **課題**: Google Calendar の予定とは別に管理する必要がある
- **検討**: 設定ファイルや環境変数で管理できるか？それとも動的に変更する必要があるか？

### 4. ユーザー情報の管理

- **要件**: LINE ユーザー ID と表示名のマッピング、次の予約情報を表示するために、ユーザーごとの予約履歴を管理する必要があるかもしれない
- **課題**: Google Calendar の予定から逆引きできるか？それとも別途管理が必要か？
- **検討**: Google Calendar の予定から逆引きできるか？それとも別途管理が必要か？

### 5. 予約の履歴管理

- **要件**: 確定前のリクエスト履歴、キャンセルされた予約の履歴
- **課題**: 履歴管理は必要か？それとも確定した予約だけ Google Calendar に残せば十分か？
- **検討**: 履歴管理は必要か？それとも確定した予約だけ Google Calendar に残せば十分か？

---

## データベースなしで実現できる可能性

### Google Calendar の拡張データ

- 予定の説明欄やカスタムプロパティに状態情報を保存
- **メリット**: 追加のストレージ不要
- **デメリット**: Google Calendar API の制限、検索・フィルタリングが困難

### メモリベースの一時管理

- Cloud Functions のメモリで一時的に状態を管理（再起動で失われる）
- **メリット**: 実装が簡単、追加コストなし
- **デメリット**: 永続化されない、同時リクエストの管理が困難

### ファイルベース

- Cloud Storage などで JSON ファイルとして管理
- **メリット**: 永続化される、追加コストが低い（無料枠内で運用可能）
- **デメリット**: 同時書き込みの競合処理が必要、検索・フィルタリングが困難

---

## 検討が必要な点

### 美容師側の管理画面の必要性

- **管理画面あり**: リクエスト一覧を表示、承認/拒否の操作、状態の確認
  - → データベースが必要になる可能性が高い
- **管理画面なし**: LINE チャットやメッセージで完結
  - → データベースなしで実現できる可能性がある

### 予約リクエストの永続化の必要性

- **永続化必要**: リクエストの履歴管理、タイムアウト処理、再試行
  - → データベースまたはファイルベースが必要
- **永続化不要**: 確定した予約だけ Google Calendar に保存
  - → データベースなしで実現できる可能性がある

### 状態管理の複雑さ

- **同時リクエスト**: 同じ時間帯への複数のリクエスト
- **タイムアウト処理**: 一定時間経過後のリクエストの自動キャンセル
- **競合処理**: 同時刻リクエストによる競合の原子性の担保

---

## Phase 1 での推奨アプローチ

### 予約リクエストの一覧表示がマストになったため

**予約リクエストの一覧表示（美容師側）が必須要件**となったため、以下のいずれかが必要：

1. **データベース**: Firebase Firestore または Supabase（推奨）

   - リクエストの永続化、検索・フィルタリングが容易
   - リアルタイム更新が可能
   - 無料枠内で運用可能

2. **ファイルベース**: Cloud Storage で JSON ファイルとして管理
   - シンプルな実装
   - 無料枠内で運用可能
   - 同時書き込みの競合処理が必要

### 最小構成（ファイルベース）

1. **予約リクエストの状態管理**: Cloud Storage の JSON ファイルで管理
2. **予約リクエストの一覧表示**: Cloud Storage の JSON ファイルから読み取り
3. **長期休暇のお知らせ**: Cloud Storage の JSON ファイルで管理
4. **ユーザー情報**: Google Calendar の予定から逆引き（LINE ユーザー ID を予定の説明欄に保存）
5. **履歴管理**: 確定した予約だけ Google Calendar に保存（確定前のリクエストは JSON ファイルに保持）

### 推奨構成（データベース使用）

1. **予約リクエストの状態管理**: Firebase Firestore で管理
2. **予約リクエストの一覧表示**: Firebase Firestore から取得
3. **長期休暇のお知らせ**: Firebase Firestore で管理
4. **ユーザー情報**: Firebase Firestore で管理（LINE ユーザー ID と表示名のマッピング）
5. **履歴管理**: Firebase Firestore で管理（確定前のリクエストも保持）

---

## データベース選択肢（必要になった場合）

### 無料枠がある選択肢

1. **Firebase Firestore**

   - GCP エコシステム内で連携が容易
   - 無料枠: 読み取り 5 万回/日、書き込み 2 万回/日
   - リアルタイム更新が可能

2. **Supabase**

   - PostgreSQL ベース
   - 無料プラン: 500MB のデータベース、2GB のファイルストレージ
   - オープンソース

3. **Cloud Storage（JSON ファイル）**
   - GCP の無料枠内で利用可能
   - 5GB のストレージ、5GB のアウトバウンドデータ転送まで無料
   - シンプルな実装

### 推奨（必要になった場合）

- **Firebase Firestore**: GCP エコシステム内で連携が容易、無料枠が十分
- **Cloud Storage（JSON ファイル）**: シンプルな要件なら十分、無料枠内で運用可能

---

## 結論

**予約リクエストの一覧表示（美容師側）が必須要件**となったため、**データベースまたはファイルベースが必要**。

### 推奨: Firebase Firestore

**理由:**

1. GCP エコシステム内で連携が容易
2. 無料枠が十分（読み取り 5 万回/日、書き込み 2 万回/日）
3. リアルタイム更新が可能（美容師側の管理画面で即座に反映）
4. 検索・フィルタリングが容易（状態、日時、ユーザーなどで絞り込み可能）
5. 同時書き込みの競合処理が自動で行われる

### 代替案: Cloud Storage（JSON ファイル）

- シンプルな実装で済む
- 無料枠内で運用可能
- ただし、同時書き込みの競合処理を自前で実装する必要がある
- 検索・フィルタリングも自前で実装する必要がある

**Phase 1 では Firebase Firestore を推奨**（無料枠内で運用可能で、開発効率が高い）。
