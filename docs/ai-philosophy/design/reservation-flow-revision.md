# 予約リクエストフローの再検討

**作成日**: 2025-11-11
**目的**: 承認と FIX の分離について再検討し、より自然なフローを提案

---

## 問題点

### 現在の設計

1. **承認** → `approved` 状態に更新
2. **FIX** → Google Calendar に予定作成 → `fixed` 状態に更新

### 問題

**「承認済み（`approved`）」状態の存在意義が不明確:**

- **正常系**: 承認後すぐ FIX するため、`approved`状態は数秒間だけ存在
- **異常系**: FIX 失敗時にのみ`approved`状態が残る

→ **「承認済み」状態は、エラー時のみ表示される状態になってしまう**

---

## 設計の選択肢

### 選択肢 1: 承認と FIX を統合する（推奨）

**フロー:**

1. **承認** → 即座に Google Calendar に予定作成
   - 成功: `fixed` 状態に更新
   - 失敗: `requested` 状態のまま（エラー表示）

**メリット:**

- シンプルで直感的
- 不要な中間状態（`approved`）を排除
- ユーザー操作が 1 回減る

**デメリット:**

- 承認と Google Calendar 反映を分離できない
- 将来的に調整機能を追加する際、設計変更が必要

**実装:**

- 承認ボタンを押すと、即座に Google Calendar API を呼び出し
- 成功すれば`fixed`、失敗すればエラー表示

### 選択肢 2: 承認済み状態を保持する（現在の設計）

**フロー:**

1. **承認** → `approved` 状態に更新
2. **FIX** → Google Calendar に予定作成 → `fixed` 状態に更新

**メリット:**

- 将来的に調整機能を追加しやすい
- 承認と Google Calendar 反映を分離できる

**デメリット:**

- 不要な中間状態が存在
- ユーザー操作が 2 回必要
- 「承認済み」状態がほとんど表示されない

**実装:**

- 承認ボタンと FIX ボタンを分離
- 承認済み状態を一覧に表示（ただし、正常系ではすぐ FIX されるため表示されない）

### 選択肢 3: 承認済み状態を表示しない（ハイブリッド）

**フロー:**

1. **承認** → `approved` 状態に更新（内部的に保持）
2. **FIX** → Google Calendar に予定作成 → `fixed` 状態に更新

**UI:**

- 一覧には「リクエスト中」と「確定済み」のみ表示
- 「承認済み」状態は内部的に保持するが、UI には表示しない
- 承認後、自動的に FIX 処理を実行（または、承認ボタンを押すと FIX まで一括実行）

**メリット:**

- 内部的には承認済み状態を保持（将来の拡張に備える）
- UI はシンプル（不要な状態を表示しない）

**デメリット:**

- 状態管理が複雑になる可能性

---

## 推奨: 選択肢 1（承認と FIX を統合）

### 理由

1. **MVP では調整機能がない**

   - 3 段階フロー（リクエスト → 承認/調整 → FIX）の「調整」が MVP に含まれない
   - 承認後すぐ FIX する想定なので、2 段階にする意味が薄い

2. **ユーザー体験**

   - 承認ボタンを押すと即座に Google Calendar に反映される方が直感的
   - 不要な中間状態を排除できる

3. **エラーハンドリング**
   - Google Calendar 反映に失敗した場合、エラー表示して`requested`状態のまま
   - 再試行可能

### 実装方針

**API 設計:**

- `POST /api/reservations/requests/:id/approve` を統合
- 承認と同時に Google Calendar に予定作成
- 成功: `fixed` 状態に更新
- 失敗: エラーを返し、`requested` 状態のまま

**UI 設計:**

- 承認ボタンを押すと、ローディング表示
- 成功: 「確定済み」として表示
- 失敗: エラーメッセージを表示、再試行可能

**状態遷移:**

```
requested → (承認) → fixed
         ↓ (失敗)
      requested (エラー表示、再試行可能)
```

---

## 将来の拡張（Phase 2 以降）

### 調整機能を追加する場合

**フロー:**

1. **承認** → `approved` 状態に更新
2. **調整**（オプション）→ `adjusting` 状態に更新 → LINE 等で調整
3. **FIX** → Google Calendar に予定作成 → `fixed` 状態に更新

**実装:**

- 承認と FIX を分離
- 承認済み状態を表示
- 調整機能を追加

---

## 修正が必要なドキュメント

1. **システム設計ドキュメント**

   - API 設計の修正（承認と FIX を統合）
   - 状態遷移図の修正

2. **MVP 作成プラン**

   - 実装タスクの修正

3. **UI プロトタイプ**
   - 承認ボタンの動作を修正（FIX まで一括実行）

---

## 結論

**MVP では、承認と FIX を統合する設計を推奨します。**

- シンプルで直感的
- 不要な中間状態を排除
- ユーザー操作が 1 回減る
- 将来的に調整機能を追加する際は、設計を変更して分離可能
