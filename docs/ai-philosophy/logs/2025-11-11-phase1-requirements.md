# 日付: 2025-11-11

## 背景・課題

長年お世話になっているフリーの美容師が、Google Calendar で予約を管理している。新規予約は口頭や LINE で受け、都度 Google Calendar に手入力しており負担が大きい。手入力の手間・漏れ・二重予約のリスクを低減したい。

## ステークホルダー

- 主要利用者: フリーの美容師（個人事業）
- エンドユーザー: お客さん（予約を行う人）
- 運用者/管理者: 美容師本人（暫定）

## 目的（アウトカム）

- 手入力作業をほぼゼロにする
- 予約漏れ・二重予約を防止する
- お客さんがアプリから予約し、即座に美容師の Google Calendar に予定が入る

## 要件（現時点）

- 機能要件
  - お客さんがアプリから予約リクエストを送れる（LIFF アプリ前提）
  - LIFF 経由で LINE ユーザー ID と表示名を取得し、予約リクエスト時の名前入力を省略
  - 次の予約情報をユーザー名付きで表示（例: 「○○ さんの次の予約は...」）
  - 予約リクエスト → 承認/調整 → FIX の 3 段階フロー
  - **予約リクエストの一覧表示（美容師側）**: 承認・調整待ちのリクエストを管理できる（マスト）
  - 予約確定時に対象の Google Calendar に予定を自動作成
  - 美容師が手入力した予定をアプリに反映（双方向同期）
  - 二重予約の防止（空き枠の判定）
  - 予約内容（日時、メニュー、顧客名、連絡手段）を保存
  - 長期休暇などのお知らせをアプリ上に表示する機能（美容師が設定可能）
- 非機能要件
  - シンプルな初期導入（Phase 1 は最小 UX で可）
  - タイムゾーン/営業時間の扱いを誤らないこと
  - 個人の Google アカウントで動作（Google Workspace は不要）
  - 既存の LINE/口頭フローとの併存（移行期間の運用）

## 制約・前提

- Google Calendar API を使用（OAuth 2.0 認可が必要）
- 美容師の Google アカウントに対し、当アプリが予定作成権限を得る
- 初期は単一の美容師・単一カレンダーを対象（複数対応は Phase 2 以降）
- メニュー・所要時間は初期は固定（単一美容師対象）、拡張性は考慮
- Google Calendar の予定フォーマット取り決めが必要（美容師との合意事項）
  - アプリで作成した予定の識別方法
  - 手入力予定との区別方法
  - 予約情報（メニュー、顧客名、連絡手段）の記録方法

## 成功指標（暫定）

- 手入力による予約登録回数が 90%以上削減
- 二重予約ゼロ
- 予約確定からカレンダー反映まで 3 秒以内（体感）

## 決定事項

- **予約承認フロー**: 3 段階（リクエスト → 承認/調整 → FIX）
  - ① お客さんがメニューと時間帯を指定してリクエスト
  - ② 美容師がそのまま承認 or LINE 等で調整
  - ③ 調整済みなら美容師が FIX
- **メニュー・所要時間**: 初期は固定（単一美容師対象）、拡張性を考慮
- **通知機能**: サービスメッセージ API は不要（プッシュ通知は不要）
- **キャンセル・変更**: 現行運用維持（LINE で依頼 → 美容師が Google Calendar を手動編集）
- **アプリ形態**: **LIFF アプリ前提**（審査待ちを避けるため、開発を止めない）
- **ユーザー認証**: LIFF SDK の `liff.getProfile()` または `liff.getAccessToken()` を使用して LINE ユーザー ID と表示名を取得
- **美容師認証**: Google アカウント認証（OAuth 2.0）で、普段予約管理に使っているカレンダーを参照することを認可
- **開発手法**: **自社開発**（開発コストは考慮不要）
- **コスト方針**: API やインフラサービスの利用コスト（初期費用・運用コスト）は検討が必要。基本的には無料または個人が出せる範囲で検討
- **インフラ構成**:
  - **フロントエンド**: Vercel の無料プラン（GitHub 連携が強い）
  - **バックエンド**: GCP Cloud Functions の無料枠（REST/GraphQL API として構築）
  - **データベース**: Firebase Firestore（予約リクエストの一覧表示のため必須）
  - **想定コスト**: 0 円/月（無料枠内での運用が可能）
- **開発言語・フレームワーク**:

  - **フロントエンド**: Next.js 14+ (App Router) + TypeScript
  - **バックエンド**: Node.js 18+ + TypeScript + Express.js
  - **スタイリング**: Tailwind CSS
  - **状態管理**: React Hooks（必要に応じて Zustand）
  - **フォーム管理**: React Hook Form
  - **バリデーション**: Zod

- **アーキテクチャ設計方針**:
  - **リポジトリパターン**: データベースアクセスを抽象化し、ドメイン層とインフラ層を分離
  - **ユースケース**: アプリケーション層でビジネスロジックを明確化
  - **依存性の逆転**: インターフェースをドメイン層に定義し、実装をインフラ層に配置
  - **段階的発展**: 必要に応じて DI コンテナやモジュールシステムを追加可能な構造
  - **保守性重視**: Clean Architecture の原則を取り入れつつ、サーバーレス環境との相性も考慮
  - **Nest.js は不使用**: サーバーレス環境との相性を優先し、Express.js で実装

## リスク・論点

- 権限付与の UX（OAuth 同意とトークン継続運用）
- 同時刻リクエストによる競合（原子性の担保）
- 既存の LINE/口頭フローとの併存（移行期間の運用）
- タイムゾーン・祝日・営業時間の扱い
- Google Calendar の予定フォーマット取り決め（美容師との合意が必要）
- 手入力予定をアプリに反映する仕組み（双方向同期の実装）
- 長期休暇のお知らせ機能の実装方法（表示タイミング、管理方法）
- API/インフラサービスの利用コスト（初期費用・運用コスト）の検討（無料枠の範囲、有料化のタイミング）
- **データベースの必要性の検討**（以下を参照）

## オープンな質問

- 3 段階承認フローの UI/UX 設計（お客さん側・美容師側、ボタンやリッチメッセージの活用方法）
- 長期休暇のお知らせの表示方法（トップページに常時表示？予約画面に表示？）
- 調整が必要な場合のやり取り方法（LINE アプリ内で完結？既存 LINE チャット併用？）

## 技術調査結果

- [LINE アプリ仕様調査結果](../research/line-app-research.md)
- [API/インフラサービスの利用コスト調査結果](../research/api-infrastructure-costs.md)
- [データベースの必要性検討](../research/database-necessity.md)

## 設計ドキュメント

- [システム設計（たたき台）](../design/system-design.md)
- [アーキテクチャ設計ガイドライン](../design/architecture-guidelines.md)
- [エラーハンドリングとリトライロジック方針](../design/error-handling-retry.md)
- [ログとモニタリング方針](../design/logging-monitoring.md)
- [MVP 作成プラン](../design/mvp-plan.md)
- [予約リクエストフローの再検討](../design/reservation-flow-revision.md)

## 次の一歩（Phase 1）

- [x] LINE アプリの仕様調査（通知機能、予約フロー実現方法、他選択肢との比較）
- [x] LINE ミニアプリ vs LIFF アプリの選択判断（LIFF アプリ前提で決定）
- [x] API/インフラサービスの利用コスト調査（Google Calendar API、LINE API、ホスティングサービス等の無料枠・料金体系）
- [ ] Google Calendar API の認可フロー最小動作確認（ローカル/テストカレンダー）
- [ ] Google Calendar の予定フォーマット取り決め案を作成（美容師との合意準備）
- [ ] 空き枠判定の設計スケッチ（所要時間・バッファの扱い）
- [ ] 3 段階承認フローの UI/UX スケッチ（リクエスト → 承認/調整 → FIX）
- [ ] LIFF SDK を使ったユーザー情報取得の実装方法確認
- [ ] 長期休暇のお知らせ機能の設計（表示方法、管理方法）
- [ ] 最小 UI プロトタイプを `prototypes/ui-sketches/` に作成
- [ ] カレンダー反映の最小 MVP を `prototypes/mvp/` に作成
- [ ] 手入力予定の読み取り・反映の設計検討（双方向同期の実装方針）
