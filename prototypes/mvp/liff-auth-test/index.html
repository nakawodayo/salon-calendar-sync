<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LIFF Ë™çË®º„ÉÜ„Çπ„Éà - „Çµ„É≠„É≥‰∫àÁ¥Ñ„Ç¢„Éó„É™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
        text-align: center;
        margin-bottom: 30px;
      }

      .status {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .status.loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .profile-card {
        display: none;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        margin-bottom: 20px;
      }

      .profile-card.visible {
        display: block;
      }

      .profile-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .profile-picture {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        object-fit: cover;
      }

      .profile-picture.placeholder {
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
      }

      .profile-name {
        font-size: 22px;
        font-weight: bold;
      }

      .profile-detail {
        background: rgba(255, 255, 255, 0.2);
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .profile-detail:last-child {
        margin-bottom: 0;
      }

      .profile-detail strong {
        display: block;
        font-size: 11px;
        opacity: 0.8;
        margin-bottom: 5px;
      }

      .profile-detail code {
        background: rgba(0, 0, 0, 0.2);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .info-section {
        display: none;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .info-section.visible {
        display: block;
      }

      .info-section h3 {
        color: #333;
        font-size: 16px;
        margin-bottom: 15px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        color: #666;
        font-weight: 500;
      }

      .info-value {
        color: #333;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .info-value.success {
        color: #28a745;
        font-weight: bold;
      }

      .info-value.error {
        color: #dc3545;
        font-weight: bold;
      }

      button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .test-results {
        display: none;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
      }

      .test-results.visible {
        display: block;
      }

      .test-results h2 {
        color: #333;
        font-size: 20px;
        margin-bottom: 15px;
      }

      .test-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
      }

      .test-icon {
        font-size: 20px;
      }

      .test-icon.success {
        color: #28a745;
      }

      .test-icon.error {
        color: #dc3545;
      }

      .test-icon.pending {
        color: #ffc107;
      }

      .footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
        text-align: center;
        color: #666;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LIFF Ë™çË®º„ÉÜ„Çπ„Éà</h1>
      <p class="subtitle">LINE LIFF SDK „ÅÆÂãï‰ΩúÁ¢∫Ë™ç„Éó„É≠„Éà„Çø„Ç§„Éó</p>

      <div id="statusMessage" class="status loading">LIFF „ÇíÂàùÊúüÂåñ‰∏≠...</div>

      <div id="profileCard" class="profile-card">
        <div class="profile-header">
          <div id="profilePicture" class="profile-picture placeholder">üë§</div>
          <div class="profile-name" id="profileName">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
        <div class="profile-detail">
          <strong>„É¶„Éº„Ç∂„ÉºID</strong>
          <code id="userId">-</code>
        </div>
        <div class="profile-detail" id="statusMessageDetail" style="display: none">
          <strong>„Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏</strong>
          <span id="statusMessageValue">-</span>
        </div>
      </div>

      <div id="infoSection" class="info-section">
        <h3>LIFF ÊÉÖÂ†±</h3>
        <div class="info-item">
          <span class="info-label">LIFF ID</span>
          <span class="info-value" id="liffIdValue">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã</span>
          <span class="info-value" id="loginStatus">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Áí∞Â¢É</span>
          <span class="info-value" id="liffContext">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">OS</span>
          <span class="info-value" id="liffOS">-</span>
        </div>
      </div>

      <div id="testResults" class="test-results">
        <h2>Âãï‰ΩúÁ¢∫Ë™çÁµêÊûú</h2>
        <div class="test-item">
          <span class="test-icon pending" id="testInit">‚è≥</span>
          <span>LIFF ÂàùÊúüÂåñ</span>
        </div>
        <div class="test-item">
          <span class="test-icon pending" id="testLogin">‚è≥</span>
          <span>„É≠„Ç∞„Ç§„É≥Áä∂ÊÖãÁ¢∫Ë™ç</span>
        </div>
        <div class="test-item">
          <span class="test-icon pending" id="testProfile">‚è≥</span>
          <span>„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó</span>
        </div>
        <div class="test-item">
          <span class="test-icon pending" id="testToken">‚è≥</span>
          <span>„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥ÂèñÂæó</span>
        </div>
      </div>

      <div class="footer">
        <p>Phase 1 „Éó„É≠„Éà„Çø„Ç§„Éó - ÊäÄË°ìÊ§úË®ºÁî®</p>
        <p>prototypes/mvp/liff-auth-test/</p>
      </div>
    </div>

    <script>
      // LIFF ID „ÅÆË®≠ÂÆöÔºàÁí∞Â¢ÉÂ§âÊï∞„Åã„ÇâË™≠„ÅøËæº„ÇÄ„Åã„ÄÅ„Åì„Åì„Å´Áõ¥Êé•Ë®òËø∞Ôºâ
      // „ÉÜ„Çπ„ÉàÊôÇ„ÅØÂÆüÈöõ„ÅÆ LIFF ID „Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
      const LIFF_ID = "2008484018-nMrvLmk6";

      // Áä∂ÊÖãÁÆ°ÁêÜ
      let liffInitialized = false;
      let userProfile = null;

      // DOMË¶ÅÁ¥†
      const statusMessage = document.getElementById("statusMessage");
      const profileCard = document.getElementById("profileCard");
      const infoSection = document.getElementById("infoSection");
      const testResults = document.getElementById("testResults");

      // „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
      function updateStatus(message, type = "loading") {
        statusMessage.textContent = message;
        statusMessage.className = `status ${type}`;
      }

      // „ÉÜ„Çπ„ÉàÁµêÊûú„Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞
      function updateTestResult(testId, status) {
        const icon = document.getElementById(testId);
        if (!icon) return;

        icon.className = `test-icon ${status}`;
        icon.textContent = status === "success" ? "‚úÖ" : status === "error" ? "‚ùå" : "‚è≥";
      }

      // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
      function displayProfile(profile) {
        document.getElementById("profileName").textContent = profile.displayName;
        document.getElementById("userId").textContent = profile.userId;

        if (profile.pictureUrl) {
          const img = document.createElement("img");
          img.src = profile.pictureUrl;
          img.className = "profile-picture";
          img.alt = profile.displayName;
          document.getElementById("profilePicture").replaceWith(img);
          img.id = "profilePicture";
        }

        if (profile.statusMessage) {
          document.getElementById("statusMessageDetail").style.display = "block";
          document.getElementById("statusMessageValue").textContent = profile.statusMessage;
        }

        profileCard.classList.add("visible");
      }

      // LIFFÊÉÖÂ†±Ë°®Á§∫
      function displayLiffInfo() {
        document.getElementById("liffIdValue").textContent = LIFF_ID;

        const isLoggedIn = liff.isLoggedIn();
        const loginStatusEl = document.getElementById("loginStatus");
        loginStatusEl.textContent = isLoggedIn ? "„É≠„Ç∞„Ç§„É≥Ê∏à„Åø" : "Êú™„É≠„Ç∞„Ç§„É≥";
        loginStatusEl.className = isLoggedIn ? "info-value success" : "info-value error";

        const context = liff.getContext();
        if (context) {
          document.getElementById("liffContext").textContent = context.type || "unknown";
        }

        const os = liff.getOS();
        document.getElementById("liffOS").textContent = os || "unknown";

        infoSection.classList.add("visible");
      }

      // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
      function handleError(error, context) {
        console.error(`Error in ${context}:`, error);

        let message = "‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";

        if (error.code) {
          switch (error.code) {
            case "INIT_FAILED":
              message = "LIFF „ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
              break;
            case "UNAUTHORIZED":
              message = "„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô";
              break;
            case "FORBIDDEN":
              message = "„Éó„É≠„Éï„Ç£„Éº„É´Ê®©Èôê„ÅåÂøÖË¶Å„Åß„Åô";
              break;
            case "INVALID_CONFIG":
              message = "Ë®≠ÂÆö„Ç®„É©„Éº„Åß„Åô";
              break;
            default:
              message = `„Ç®„É©„Éº: ${error.code}`;
          }
        }

        return message;
      }

      // „É°„Ç§„É≥Âá¶ÁêÜ
      async function initializeLiff() {
        try {
          // LIFF ID „ÉÅ„Çß„ÉÉ„ÇØ
          if (LIFF_ID === "YOUR_LIFF_ID_HERE") {
            updateStatus("‚ö†Ô∏è LIFF ID „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàindex.html „ÅÆ LIFF_ID Â§âÊï∞Ôºâ", "error");
            updateTestResult("testInit", "error");
            return;
          }

          // „ÉÜ„Çπ„ÉàÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫
          testResults.classList.add("visible");

          // 1. LIFF ÂàùÊúüÂåñ
          updateStatus("LIFF „ÇíÂàùÊúüÂåñ‰∏≠...", "loading");
          await liff.init({ liffId: LIFF_ID });
          liffInitialized = true;
          updateTestResult("testInit", "success");
          updateStatus("LIFF „ÅÆÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü", "success");

          // LIFFÊÉÖÂ†±Ë°®Á§∫
          displayLiffInfo();

          // 2. „É≠„Ç∞„Ç§„É≥Áä∂ÊÖãÁ¢∫Ë™ç
          updateStatus("„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠...", "loading");
          if (!liff.isLoggedIn()) {
            updateTestResult("testLogin", "error");
            updateStatus("Êú™„É≠„Ç∞„Ç§„É≥„Åß„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "info");

            // Ëá™Âãï„É≠„Ç∞„Ç§„É≥ÔºàÈñãÁô∫ÊôÇ„ÅØ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÂèØÔºâ
            // liff.login();
            return;
          }
          updateTestResult("testLogin", "success");

          // 3. „Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó
          updateStatus("„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂèñÂæó‰∏≠...", "loading");
          userProfile = await liff.getProfile();
          updateTestResult("testProfile", "success");
          displayProfile(userProfile);

          // 4. „Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥ÂèñÂæó
          updateStatus("„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥„ÇíÁ¢∫Ë™ç‰∏≠...", "loading");
          const accessToken = liff.getAccessToken();
          if (accessToken) {
            updateTestResult("testToken", "success");
            console.log("Access Token (first 20 chars):", accessToken.substring(0, 20) + "...");
          } else {
            updateTestResult("testToken", "error");
          }

          // ÂÆå‰∫Ü
          updateStatus("‚úÖ „Åô„Åπ„Å¶„ÅÆÂãï‰ΩúÁ¢∫Ë™ç„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü", "success");

          console.log("=== LIFF Ë™çË®º„ÉÜ„Çπ„ÉàÁµêÊûú ===");
          console.log("LIFFÂàùÊúüÂåñ: OK");
          console.log("„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã: OK");
          console.log("„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó: OK");
          console.log("„É¶„Éº„Ç∂„ÉºID:", userProfile.userId);
          console.log("Ë°®Á§∫Âêç:", userProfile.displayName);
          console.log("„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥: OK");
        } catch (error) {
          const errorMessage = handleError(error, "LIFF initialization");
          updateStatus(`‚ùå ${errorMessage}`, "error");

          // „ÉÜ„Çπ„ÉàÁµêÊûúÊõ¥Êñ∞
          if (!liffInitialized) {
            updateTestResult("testInit", "error");
          } else if (error.code === "FORBIDDEN") {
            updateTestResult("testProfile", "error");
          }

          console.error("LIFF Error:", error);
        }
      }

      // LIFF SDK „É≠„Éº„ÉâÂæå„Å´ÂàùÊúüÂåñ
      window.addEventListener("load", () => {
        if (typeof liff === "undefined") {
          updateStatus("‚ùå LIFF SDK „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
          return;
        }
        initializeLiff();
      });
    </script>
  </body>
</html>
